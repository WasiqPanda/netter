// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

// Camp locations (permanent static locations)
model Camp {
  id          String   @id @default(cuid())
  name        String
  unit        String
  hqId        String
  hq          HQ       @relation(fields: [hqId], references: [id])
  latitude    Float
  longitude   Float
  description String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  patrols    Patrol[]
  sosAlerts  SOSAlert[]
}

// Patrols (Patrol Commanders)
model Patrol {
  id            String   @id @default(cuid())
  code          String   @unique // Access code (1526)
  name          String   // Commander name/callsign
  campId        String
  camp          Camp     @relation(fields: [campId], references: [id])
  hqId          String
  hq            HQ       @relation(fields: [hqId], references: [id])
  unit          String
  strength      Int      // Number of personnel
  status        String   @default("idle") // idle, patrolling, sos, offline
  currentLatitude  Float?
  currentLongitude Float?
  lastLocationAt DateTime?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  sessions      PatrolSession[]
  sosAlerts     SOSAlert[]
  locationHistory LocationHistory[]
  bufferedLocations BufferedLocation[] // Offline buffer
}

// Daily patrol sessions
model PatrolSession {
  id            String   @id @default(cuid())
  patrolId      String
  patrol        Patrol   @relation(fields: [patrolId], references: [id], onDelete: Cascade)
  date          String   // YYYY-MM-DD format
  startTime     DateTime
  endTime       DateTime?
  status        String   @default("active") // active, completed
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  locations     LocationHistory[]
}

// GPS location history for patrols
model LocationHistory {
  id          String   @id @default(cuid())
  patrolId    String
  patrol      Patrol   @relation(fields: [patrolId], references: [id], onDelete: Cascade)
  sessionId   String?
  session     PatrolSession? @relation(fields: [sessionId], references: [id], onDelete: SetNull)
  latitude    Float
  longitude   Float
  altitude    Float?
  accuracy    Float?
  timestamp   DateTime
  createdAt   DateTime @default(now())

  @@index([patrolId])
  @@index([timestamp])
  @@index([sessionId])
}

// Buffered locations for offline mode
model BufferedLocation {
  id          String   @id @default(cuid())
  patrolId    String
  patrol      Patrol   @relation(fields: [patrolId], references: [id], onDelete: Cascade)
  latitude    Float
  longitude   Float
  altitude    Float?
  accuracy    Float?
  timestamp   DateTime
  synced      Boolean  @default(false)
  createdAt   DateTime @default(now())

  @@index([patrolId])
  @@index([synced])
}

// SOS alerts
model SOSAlert {
  id            String   @id @default(cuid())
  patrolId      String
  patrol        Patrol   @relation(fields: [patrolId], references: [id])
  campId        String?
  camp          Camp?    @relation(fields: [campId], references: [id])
  hqId          String?
  hq            HQ?      @relation(fields: [hqId], references: [id])
  latitude      Float
  longitude     Float
  message       String?
  status        String   @default("active") // active, responding, resolved
  alertedNearby String?  // JSON array of nearby patrol IDs
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@index([status])
  @@index([createdAt])
}

// HQ/Agency (Controlling Authority)
model HQ {
  id          String   @id @default(cuid())
  name        String   @unique // e.g., "10 Div", "65 BDE"
  displayName String?  // User-friendly name
  code        String   @unique // HQ access code (e.g., 8993)
  logoUrl     String?  // PNG logo URL
  isActive    Boolean  @default(true)
  isApproved  Boolean  @default(false)
  createdBy   String?  // Super Admin ID
  creator     SuperAdmin? @relation("CreatedHQs", fields: [createdBy], references: [id])
  approvedBy  String?
  approver    SuperAdmin? @relation("ApprovedHQs", fields: [approvedBy], references: [id])
  approvedAt  DateTime?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  patrols    Patrol[]
  camps      Camp[]
  sosAlerts  SOSAlert[]
  subscriptions Subscription[]
}

// Subscription Plans
model SubscriptionPlan {
  id          String   @id @default(cuid())
  name        String   @unique // e.g., "72 hours-Pro Use"
  description String
  price       Float    // in USD
  durationDays Int     // Subscription duration in days
  features    String   // JSON array of features
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  subscriptions Subscription[]
}

// User Subscriptions
model Subscription {
  id          String   @id @default(cuid())
  hqId        String
  hq          HQ       @relation(fields: [hqId], references: [id], onDelete: Cascade)
  planId      String
  plan        SubscriptionPlan @relation(fields: [planId], references: [id])
  startDate   DateTime @default(now())
  endDate     DateTime
  isActive    Boolean  @default(true)
  warningSent Boolean  @default(false)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([hqId])
  @@index([endDate])
  @@index([isActive])
}

// Super Admin
model SuperAdmin {
  id        String   @id @default(cuid())
  username  String   @unique
  password  String   // Hashed password
  name      String
  email     String   @unique
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  createdHQs  HQ[] @relation("CreatedHQs")
  approvedHQs HQ[] @relation("ApprovedHQs")
}
